---
title: 'Взаимосвязи в компании: отчет'
author: "Щудро Виктория, vischudro_1"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Загрузка данных

```{r message = F}
library(igraphdata)
library(igraph)
library(dplyr)
data(enron) 
library(lubridate)
source("~/shared/minor2_2023/2-tm-net/hw/personalTask.R")
start_date = hw_net_get_start_date()
# определяем конечную точку месяца
last_date = start_date + dmonths(1)
time = as_date(as_datetime(E(enron)$Time))
# убираем вершины раньше начальной точки и позже конечной
net = enron %>% delete_edges(E(enron)[time < start_date | time > last_date])
# убираем связи вершины самой с собой (согласно данным, иногда люди себя в копию ставят)
net = simplify(net, remove.multiple = F)
# убираем обособленные вершины
net = net %>% delete_vertices(V(net)[degree(net) == 0])
hw_net_get_vertex(net)
```

Анализируются данные с `r start_date` по `r last_date`


## Описание сети

Для начала опишем общие параметры сети связей (письмах, отправленных или полученных работниками) между сотрудниками данной компании за **март** 2001 года.

```{r message = F}
net
E(net)
V(net)
```

Заметим, что сеть имеет 122 вершины (каждая вершина обозначает одного сотрудника) и 5620 ребер (количество связей между сотрудниками). Сеть является направленной (т.к. письмо имеет своего адресата). Вершины имеют такие атрибуты, как Email (адрес почты), Name (имя сотрудника) и Note (должность сотрудника), а ребра - Time (время отправки письма), Reciptype (тип адресата - to = основной адресат, cc = в копии, bcc = в скрытой копии), Topic (тема, к которой отнесено письмо) и LDC_topic (к какой теме относится письмо - одна из 32 тем, выделенных вручную. LDC_topic = 0 значит, что письмо не относится ни к одному из выделенных топиков, слишком мало слов в сообщении, LDC_topic = -1 значит, что слов в сообщении достаточно, но письмо не удалось отнести ни к одной из 32 тем).

Теперь давайте визуализируем данную сеть с условием, что мы удалим подписи у вершин, так как просто порядковый номер нам не даст дополнительной информации, а нанесение ФИО сделает график нечитаемым.  

```{r warning=FALSE}
l <- layout_with_fr(net)
plot(net,
     layout = l,
     vertex.size = 10,
     vertex.label = NA,
     vertex.color = "purple",
     vertex.frame.color = "gray",
     vertex.label.color = "black",
     edge.color = "gray",
     edge.arrow.size = 0.5,
     edge.curved = 0.2,
     asp = 0.5,  # Adjust the aspect ratio
     xlim = c(-0.5, 0.5),  # Adjust x-axis limits for better spacing
     ylim = c(-1, 1),
     margin = 0.1)
```
Уже сейчас можем заметить странности в данной сети: есть ряд людей, который общался между собой, совершенно не коммуницируя с основной массой сотрудников (что сформировало одну отдельную группу), а также ряд групп вокруг, которые также находятся на некотором расстоянии от основной массы сотрудников. 



### Выявление значимых вершин
**Использованные меры центральности: **
Для начала предлагаю использовать такую меру центральности, как **степень**. Степень обозначает количество связей определенной вершины (сотрудника) с другими вершинами. В данном случае степень будет просто количеством отправленных/полученных писем. Если вершина обладает наибольшей степенью, то это значит, что данный сотрудник больше всех отправлял или получал письма по сравнению с другими сотрудниками. Посчитаем степени всех вершин, отсортировав их по величине:

```{r message = F}
sort.int(degree(net))
```

Для более наглядного представления предлагаю визуализировать сеть в соответствии со степенями вершин:

```{r warning=FALSE}
plot(net, 
     vertex.size = degree(net) * 0.05, # размер вершин пропорционален степени
     vertex.label = NA, # скрываем подписи вершин
     vertex.color = "lightblue", 
     edge.color = "gray")
```

Однако представление графа по индексам вершин достаточно неинформативно, поэтому предлагаю преобразовать данные в отдельный датасет, где мы сопоставим ФИО сотрудника со степенью соответствующей ему вершины и выведем данные по сотрудникам в порядке убывания степени их вершины. 
```{r message = F}
df=igraph::as_data_frame(net,what='vertices')
df=df%>%mutate(degree=degree(net))
print(df[order(df$degree, decreasing = TRUE),][1:5, ] )
```
Теперь мы можем сделать вывод относительно того, через каких людей проходило наибольшее количество писем: рассмотрим топ-5 сотрудников по количеству трансакций по электронной почте.

1) исполнительный директор по связям с государственными органами (Jeff Dasovich)

2) вице-президент по связям с государственными органами (James Steffes)

3) вице-президент по нормативно-правовым вопросам (Richard Shapiro)

4) неизвестно (Tana Jones)

5) вице-президент по оптовым услугам (Richard Sanders)

Итак, вполне логично, что именно эти сотрудники оказываются наиболее связанными с другими сотрудниками по оценке трансакций через их почту: из-за специфики своей работы они наиболее часто общаются с окружающими, что увеличивает количество трансакций через их почту. 

Вывод: некоторые вершины являются более значимыми по показателю степени, т.е. сотрудники, обозначенные данными вершинами, больше всех отправляли или получали письма по сравнению с их коллегами. Это связано прежде всего со спецификой деятельности этих людей. 


Теперь предлагаю посмотреть на такую меру центральности, как **битвинность**. Она характеризует долю кратчайших путей проходящих через данную вершину, т.е. являются ли вершины посредниками между группами, связывающими звеньями для других работников. Посчитаем битвинность всех вершин, отсортировав их по величине:

```{r message = F}
sort.int(betweenness(net))
```

Для более наглядного представления предлагаю визуализировать сеть в соответствии с битвинностями вершин:

```{r warning=FALSE}

max_degree <- max(betweenness(net))
col <- rainbow(max_degree)[betweenness(net) + 1]
layout <- layout_with_fr(net, niter = 1000)
plot(net, 
     layout = layout,
     vertex.size = betweenness(net) / 50, 
     vertex.label = NA, 
     vertex.color = col, 
     edge.width = 0.5,
     edge.color = "gray",
     edge.curved = 0.3) 
```
Поскольку график опять же не дает понять, кто именно из сотрудников обладает наибольшей битвинностью, предлагаю дополнить таблицу данными о битвинности сотрудников

```{r}
df=df%>%mutate(betweenness=betweenness(net))
print(df[order(df$betweenness, decreasing = TRUE),][1:5, ] )
```
Теперь мы можем сделать вывод относительно того, какие люди являются главными связующими звеньями среди других сотрудников: рассмотрим топ-5 сотрудников по битвинности

1) генеральный директор американского филиала (John Lavorato)

2) менеджер (Michael Grigsby)

3) GR-менеджер (Jeff Dasovich)

4) вице-президент (Barry Tycholiz)

5) менеджер (Philip Allen)

Через этих сотрудников намного проще выйти на других людей в компании, что делает их наиболее важными связущими звеньями корпорации. Заметим, что специфика их работы объясняет такое положение: они связывают большое количество людей из-за управленческих функций, поэтому и обладают высокой битвинностью. 

Вывод: некоторые вершины являются более значимыми по показателю битвинности, т.е. сотрудники, обозначенные данными вершинами, связывают наибольшее количество людей, являясь кратчайшим путем для дальнейших взаимосвязей. Это связано прежде всего со спецификой деятельности этих людей. 


### Выявление сообществ

**Использованные меры выделения сообществ: **

Для начала ращзметим различные собщества внутри рабочего коллектива с помощью механизма **Walktrap** (случайные пути). Посчитаем количество сообществ и выведем их по порядку. 

```{r warning=FALSE}
wtcommune <- walktrap.community(net)
sort.int(membership(wtcommune))
n_communities <- length(unique(wtcommune$membership))
table(wtcommune$membership)
```

Как можем заметить, всего выделено 23 сообщества. 

Теперь предлагаю рассмотреть такой показатель, как **модулярность**. Этот показатель отражает качество разбиения за счет сравнения реального разбиения со случайным (доля рёбер от общего числа рёбер, которые попадают в данные группы минус ожидаемая доля рёбер, которые попали бы в те же группы, если бы они были распределены случайно). Сети с высокой модулярностью имеют плотные связи между узлами внутри групп, но слабые связи между узлами в различных группах. 

```{r message = F}
modularity(wtcommune)
```
Значение модулярности равно **0,65**, что означает, что а) группы выделены достаточно качественно (значение модулярности больше 0,5), б) что сообщество достаточно фрагментировано на группы


Теперь предлагаю визуализировать данную сеть с учетом разбиения на группы. Подписи также уберем за ненадобностью и нечитаемостью графика. 

```{r warning=FALSE}
plot(wtcommune, 
     vertex.size = 5, 
     vertex.label= NA,
     net,
     simplify = TRUE)

```
**Вывод**: в сети связей между сотрудниками компании может быть выделено 23 сообщества. При этом во многих сообществах (что было достаточно ожидаемо, учитывая количество сообществ) находится только 1 сотрудник (с 13 по 23), то есть 11 человек не включены ни в один коллектив внутри корпорации. Также в сообществе 9 находится только 2 человека, в сообществе 3 - 3 человека. Это значит, что есть ряд сотрудников, которые не включены ни в одно из сообществ или же просто плохо интегрированы во внутренние процессы компании. Также есть ряд обособленных сообществ, состоящих из малого количества людей, что вновь провоцирует фрагментацию коллектива. При этом есть 9 устойчивых сообществ внутри компании, сотрудники которых плотно взаимодействуют друг с другом (если мы определим более-менее крупное сообщество от 5 человек).

Теперь воспользуемся механизмом **Girvan–Newman algorithm**, основанном на последовательном удалении связей в порядке убывания показателей битвинности ребер (edge betweenness scores), для сравнения полученных результатов. За данным алгоритмом стоит следующая интуиция: число связей между членами одного сообщества должно быть больше, чем число связей между сообществами. 
```{r warning=FALSE}
ebcommune <- edge.betweenness.community(net)
sort.int(membership(ebcommune))
n_communities_eb <- length(unique(ebcommune$membership))
table(ebcommune$membership)
```
Как можем заметить, всего выделено 60 сообществ, что, на мой взгляд, является не совсем адекватной оценкой для количества групп внутри сообщества количеством в 121 человек. Однако, продолжим анализ. 

Визуализируем полученный результат:

```{r message = F}
plot(ebcommune, 
     vertex.size = 5, 
     vertex.label=NA, 
     simplify = TRUE,
     net)
```
Теперь предлагаю рассмотреть такой показатель, как **модулярность**. Этот показатель отражает качество разбиения за счет сравнения реального разбиения со случайным (доля рёбер от общего числа рёбер, которые попадают в данные группы минус ожидаемая доля рёбер, которые попали бы в те же группы, если бы они были распределены случайно). Сети с высокой модулярностью имеют плотные связи между узлами внутри групп, но слабые связи между узлами в различных группах.

```{r message = F}
modularity(ebcommune)
```

Значение модулярности равно **0.58**, что показывает, что качество разбиения по этому алгоритму уступает качеству механизма Walktrap (что было понятно изначально из данных), поэтому в дальнейших рассуждениях будем опираться на результаты, полученные с помощью механизма Walktrap. 

Дополнительно провизуализируем данный метод, чтобы было лучше видно связь между агентами без наслоений цветов:

```{r warning=FALSE}
library(ggraph)
library(igraph)

V(net)$community <- igraph::betweenness(net)
community_colors <- rainbow(length(unique(V(net)$community)))

V(net)$group <- edge.betweenness.community(net)$membership


ggraph(net, layout = l) +
  geom_node_point(aes(color = factor(V(net)$community), size = log(degree(net))*3)) +
  geom_edge_link() +
  scale_color_manual(values = community_colors, guide = FALSE) +
  theme_void() +
  labs(title = "Network Visualization")

```



### Исследовательские вопросы

**Вопрос 1:**

**Правда ли, что сотрудники с похожими должностями будут скорее формировать связи друг с другом?**

Исследовательский вопрос возникает из предположения, что чем выше должность у сотрудника, тем меньше он взаимодействует с низшими по звеньям коллегами. Лидеры чаще общаются между собой, что формирует закрытую сеть.

Для решения этого вопроса применяется метод ассортативности или гомофилии, который оценивает склонность узлов сети к связям с узлами, имеющими схожие характеристики. В данном случае анализируется должность сотрудника как атрибут. Результаты теста ассортативности находятся в диапазоне от -1 до 1, где -1 указывает на склонность к связям между узлами с различными характеристиками, 1 - на предпочтение связей между схожими узлами (например, по полу), а 0 - на формирование связей независимо от данной характеристики.

Проведем тест ассортативности для номинальной переменной должности:

```{r, warning=FALSE}
vertex_types <- as.integer(as.factor(V(net)$Note))
assortativity_nominal(net, vertex_types, directed = TRUE)
```
Коэффициент ассортативности 0.02685899 указывает на то, что в данной сети наблюдается очень слабая тенденция к формированию связей между узлами с похожими характеристиками. В нашем случае это означает, что на самом деле нет никакой связи между занимаемой должностью и контактами с коллегами. 

Однако нельзя быть уверенным в достоверности полученных результатов. Поэтому дополнительно проведем тест перестановок и проверим p-value. 

```{r warning=FALSE}
vertex_types <- as.integer(as.factor(V(net)$Note))
number_of_permutations = 3000
assortativity_shuffled  <- rep(NA, number_of_permutations)
for(i in 1:number_of_permutations){
  V(net)$attr_shuffled = sample(V(net)$Note, replace = F)
  assortativity_shuffled[i] = assortativity_nominal(net,as.factor(V(net)$attr_shuffled), directed = T)}
assortativity_real = assortativity_nominal(net, as.integer(as.factor(V(net)$Note)), directed = T)
assortativity_real
```

Здесь значение коэффициента также близко к нулю, что говорит о воспроизводимости полученных результатов. 

Теперь проверим p-value. 
```{r message = F}
pvalue = sum(assortativity_shuffled <= assortativity_real) / number_of_permutations
pvalue
```
Однако p-value оказывается очень большим на любых уровнях значимости, что делает полученные результаты статистически не значимыми. 

**Выводы:** в данной сети действительно нет никакой связи между занимаемой должностью и сетью взаимодействий, но данные результаты не могут быть экстраполированы на генеральную совокупность из-за отсутствия статистической значимости результатов теста. 


**Вопрос 2:**
**Как связаны роль сотрудника как посредника между другими работниками и его должность в организации?**

Исследовательский вопрос основан на предположении, что сотрудники с более высокими должностями в большей степени выступают в качестве посредников между различными работниками. Это связано с тем, что они занимают более значимые позиции в организации и координируют работу разных подразделений.

Для проверки этого предположения можно создать отдельный датафрейм, в котором будут рассчитаны средние показатели посредничества (betweenness centrality) для групп сотрудников, выделенных по их должностям. Для удобства анализа должности также можно преобразовать из символьных значений в факторные переменные.

```{r message = F}
df1=df%>%group_by(Note)%>%summarize(MeanBetweenness=mean(betweenness))
df1 = df1 %>% mutate_if(is.character, as.factor)
```
Для проверки статистической значимости различий в средних показателях посредничества (betweenness centrality) между группами сотрудников, выделенными по их должностям, можно использовать **тест перестановок**.

```{r}
suppressMessages(library(coin))
independence_test(Note ~ MeanBetweenness, data = df1)
```
Значение p-value = 0.00008599, что делает полученные результаты статистически значимыми на любом выбранном уровне значимости. 

Посмотрим на экстремальные значения битвинности. 
```{r message = F}
print(df1[order(df1$MeanBetweenness, decreasing = FALSE),] )
print(df1[order(df1$MeanBetweenness, decreasing = TRUE),] )
```

Анализ средних показателей посредничества (betweenness centrality) для различных должностей в организации показывает следующее:

- Наиболее высокие средние значения битвинности наблюдаются у сотрудников, занимающих должности генеральных директоров и директоров (CEO Enron America, President Enron Online).

- В то же время, некоторые должности, такие как менеджеры и генеральный директор (CEO), имеют нулевые средние значения битвинности.

Это указывает на то, что нет какой-то особенно сильной связи между тем, какую должность занимают сотрудники и их посредническими функциями. 

К сожалению, более точный анализ был недоступен в связи с отсутствием четкого ранжирования должностей, что не позволило провести корреляционный анализ. В связи с этим был выбран метод оценки крайних значений в совокупности с тестом перестановок. 

**Вывод:** роль сотрудника как посредника между другими работниками и его должность в организации не связаны между собой. 

## Место сотрудника в сети

```{r message = F}
hw_net_get_vertex(net)
```

Именем моего рассматриваемого сотрудника является Errol McLaughlin. Рассмотрим его место в сети. 

```{r message = F}
which(V(net)$Name == 'Errol McLaughlin')
```

Как можем заметить, в сети Errol McLaughlin занимает 24-ое место. 

Перейдем к описанию с помощью мер центральности. 
Начнем с **центральности по степени**: 

```{r message = F}
degree(net)[24]
```
Как видно из результата, Errol McLaughlin имеет 68 связей с другими сотрудниками. Сравним с мерами центральной тенденции показателя центральности по степени:

```{r message = F}
median(degree(net))
mean(degree(net))
```
Заметим, что Errol McLaughlin менее социально активен, чем средний сотрудник данной компании, то есть он реже отправляет/получает письма по электронной почте. Однако его социальная активность выше медианной больше, чем в два раза. 

Теперь посчитаем такую меру центральности, как **битвинность**. 
```{r message = F}
betweenness(net)[24]
```

Сравним с мерами центральной тенденции:
```{r message = F}
median(betweenness(net))
mean(betweenness(net))
```
Заметим, что значение битвинности у Errol McLaughlin в четыре (!) раза меньше среднего по сотрудникам, что означает, что Errol McLaughlin не является достаточно важным связующим звеном между различными группами внутри рабочего коллектива. Парадоксально, но медианное значение битвинности настолько мало, что относительно него сотрудник более активен практически в 40 раз!

Теперь рассмотрим такую меру, как **центральность по близости**. Центральность по близости - кратчайший путь от вершины i к вершине j, т. е. минимальное число ребер, через которые надо пройти, чтобы из вершины i попасть в вершину j. По этой метрике мы сможем оценить степень вовлеченности Errol McLaughlin в общественную сеть. 

```{r}
closeness(net)[24]
```
Сравним с мерами центральной тенденции:

```{r}
median(closeness(net), na.rm = TRUE)
mean(closeness(net), na.rm = TRUE)
```
Заметим, что и центральность по близости у Errol McLaughlin ниже среднего и медианного в несколько раз, что означает, что он достаточно плохо интегрирован в коллектив и не близок с большим количеством людей. 

Теперь посмотрим, к какому из сообществ принадлежит данный сотрудник.

```{r}
membership(wtcommune)[24]
```
Итак, Errol McLaughlin принадлежит 5-му сообществу, которое, как ни странно, является самым наполненным. 

Сравним с другим механизмом:

```{r}
membership(ebcommune)[24]
```
Итак, Errol McLaughlin принадлежит 11-му сообществу, которое, также является самым наполненным. 

Судя по принадлежности к сообществам, сотрудник все же включен в обширную общественную сеть, однако сам не обладает высокими характеристиками вовлеченности в коммуникации. 

**Выводы:** Errol McLaughlin не обладает высокими показателями ни по центральности по степени, ни по центральности по близости, ни по битвинности, хотя при этом оказывается членом самого крупного сообщества (определено двумя способами), что создает несколько амбивалентное положение сотрудника в социальной системе. Вероятно, он просто работает с другими коллегами вместе, однако не является важной частью коллектива. 


## Общие выводы

1) В сети можно выделить 23 сообщества, что является достаточно большим числом; при этом довольно большое количество людей оказывается абсолютно дезинтегрировано относительно своих коллег: в группах с 13 по 23 сообщество находится всего лишь 1 человек, в некоторых сообществах - не более трех людей. В коллективе наблюдается высокая фрагментация. 

2) Должностное разделение в итоге не влияет на то, какие связи устанавливаются между сотрудниками - отправка и получение писем происходит вне зависимости от положения человека в компании. 

3) Нет никакой связи между должностной иерархией и посреднической функцией у сотрудников. Положение в иерархии не будет увеличивать или уменьшать шансы человека быть посредником в других контактах.

4) Все это указывает на то, что профессиональное сообщество - достаточно демократичное по характеру связей, хотя и достаточно высокофрагментированное. 

5) Специфика профессиональной деятельности лучше описывает характер контактов с коллегами, чем положение в иерархии: так, и главными связующими звеньями, и людьми, которые имеют больше профессиональных контактов, оказываются работники, которые по роду своей деятельности активно вовлечены в коммуникацию и координацию действий сотрудников компании. 