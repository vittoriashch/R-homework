---
title: 'HW 1: EDA на примере данных об авиаперевозках'
author: "Щудро Виктория, vischudro_1"
output: 
  html_document:
    code_folding: hide
---

## Задача

на основе данных (и выданных вопросов) постараться выяснить:

* какие проблемы есть в авиаперевозках
* какие улучшения можно предложить на основе выводов по данным

#### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)

source("~/shared/minor2_2023/1-Intro/hw1/hw1_data.R")

airline = hw1_get_data(df_name = "airline")
airport = hw1_get_data(df_name = "airport")
lounge = hw1_get_data(df_name = "lounge")
seat = hw1_get_data(df_name = "seat")

hw1_get_questions()
```

Описание преобразований в данных (замена типа переменной, преобразование дат)

* Было сделано преобразование даты в день недели

```{r message = F, warning = F} 
# преобразование данных, предобработка
library(lubridate)
airline$date = wday(airline$date, label = TRUE)


```


### Вопросы

#### Вопрос 1

**Вопрос:** Пишут ли люди более добрые отзывы на авиалинии в выходные (доброту определяем через overall_rating)?

**Данные:** для ответа на вопрос нужны таблица airline

Для обработки материалов необходимо ввести следующие переменные:

- df: the processed dataset airline

- df1: the data for weekends

- df2: the data for weekdays

- mean_end: the avg rating for weekends

- mean_work: the avg rating for weekdays

```{r message = F, warning = F} 
library(dplyr)
library(tidyr)
df = drop_na(airline, overall_rating, date)
df1 = filter(df, (date == 'Sun' | date == 'Sat'))
df2 = filter(df, (date == 'Fri' | date == 'Mon' | date == 'Tue'| date == 'Wed'| date == 'Thu'))
mean_end = mean(df1$overall_rating)
mean_work = mean(df2$overall_rating)
df = group_by(df, date) %>%
  summarize(avg_rate = mean(overall_rating))
library(ggplot2)
ggplot(df, aes(x = date, y = avg_rate, fill = date)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Ratings", x = "Day of the week", y = "Average rating")
ggplot(data.frame(x = c("Weekends", "Weekdays"), y = c(mean_end, mean_work)), aes(x, y, fill = x)) +
  geom_bar(stat = "identity") + geom_text(aes(label = round(y, 2)), vjust = -0.5) +
  labs(title = "Average rate by the date type", x = "Date Type", y = "Average Rating") + scale_fill_discrete(name = "Date Type")




```

**Ответ:** средняя оценка авиалинии в выходные дни составляет 6,32, а в рабочие дни - 6,38. В частности, средний рейтинг в субботу составляет 6,46, а в воскресенье - 6,26. Поскольку в воскресенье отзывов написано больше по количеству, средний балл падает в целом. 

**Вывод:** поскольку мы смогли обнаружить лишь факт, что в какие-то дни отзывы лучше, а в какие-то -- хуже, нам следует теперь понять, почему это происходит. Владельцам авиакомпаний можно порекомендовать внимательнее изучить отзывы в каждой категории дней, чтобы понять, что меняется в выходные (в особенности, в воскресенье). Также в будущем можно посмотреть зависимость рейтинга отзыва от вводных параметров в целом, например, от приветливости персонала, удобства кресел, качества еды и так далее. Так у владельцев будет более полная картина предпочтений их целевой аудитории, и будет понятнее, что можно изменить для большей удовлетворенности потребителей.

#### Вопрос 2

**Вопрос:** На отзывах с какой оценкой чаще встречается упоминание грязи или чистоты в лаунж зоне?

**Данные:** для ответа на вопрос нужна таблица lounge


```{r message = F, warning = F} 
# код для ответа на вопрос 2:
# нужные преобразования, построение графика, если нужен
library(stringr)
data_clean = mutate(lounge, exist = str_detect(content,'cleanliness|clean|unclean|dirt|dirty|greasy|tidy|not clean|not too clean|not very clean|not too dirty|not very dirty|purity|\nclean|very clean|very dirty'))
data_clean = filter(data_clean, exist == T)
data_clean =  group_by(data_clean, overall_rating) %>% summarize(count = n()) %>% arrange(desc(count))

ggplot(data_clean, aes(x = overall_rating, y = count, fill = as.factor(overall_rating))) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  labs(title = "Count of (un)cleanliness-related terms",
       x = "Overall score",
       y = "Count") +
 scale_fill_brewer(palette = "Set2") +   theme_classic() +   scale_x_discrete(breaks = unique(data_clean$overall_rating)) + scale_fill_discrete(name = "Rating points")


```

**Ответ:** Наибольшее количество упоминаний чистоты/загрязненности в лаундж зоне встречается среди отзывов с оценкой = 3. 

**Вывод:** Учитывая, что это низкий балл, можно предположить, что там в основном встречаются жалобы на недостаточную ухоженность этой зоны. Для улучшения общего рейтинга можно порекомендовать более тщательный контроль за уборкой помещений, чтобы у посетителей оставалось приятное впечатление от нахождения в лаундж зоне. 

#### Вопрос 3

**Вопрос:** В какой стране больше всего самолётов AIRBUS? а в какой BOEING?

**Данные:** для ответа на вопрос нужны таблицы seat и airport

Для обработки материалов необходимо ввести следующие переменные:

- data_inner: the merged dataset of 2 tables

Проблема с данными состояла в следующем: ни в одной из таблиц напрямую нельзя получить название страны, к которой принадлежит авиакомпания или самолет. Поэтому было принято следующее решение: поскольку изначальная формулировка вопроса предполагает "В КАКОЙ СТРАНЕ", а не "У КАКОЙ СТРАНЫ", значит, не обязательно эти самолеты должны быть в собственности у авиакомпании. Значит, можно посмотреть, сколько самолетов двух типов в целом физически находятся в какой-то стране: для это я смерджила таблицы с отзывами на самолеты с таблицей про аэропорты (поскольку единственной связующей колонкой с датасетом аэропортов были авторы отзывов, а так можно было бы получить данные, какой самолет куда направлялся), отобрала их по фамилии автора (часто авторы летят транзитом, но данные об аэропорте все равно сохраняются) и посредством регулярных выражений привела к единообразному виду, чтобы не учитывать разные модели. Для дальнейшего анализа можно также предложить отследить взаимосвязь между типом самолета и рейтингом перевозки: возможно, какие-то самолеты отличаются особенным (дис)комфортом, что влияет на рейтинг. 
Для точности данных я вручную добавила страны, соответствующие аэропортам и сгруппировала в итоге по стране. 

```{r message = F, warning = F} 
# код для ответа на вопрос 3:
# нужные преобразования, построение графика, если нужен
data_inner = inner_join(seat, airport, by = "author")
library(stringr)
data_inner$aircraft = str_to_lower(data_inner$aircraft)
data_inner = filter(data_inner, (aircraft != 'b777-200lr' & aircraft != 'b747-400' & aircraft != 'a380' ))
data_inner$aircraft = gsub("airbus\\s\\w+", 'airbus', data_inner$aircraft)
data_inner$aircraft = gsub("airbus(-\\w+)?", 'airbus', data_inner$aircraft)
data_inner$aircraft = gsub("boeing\\s\\d{3}-\\d{3}", 'boeing', data_inner$aircraft)
data_inner$aircraft = gsub("boeing\\s\\d{3}-\\wer", 'boeing', data_inner$aircraft, ignore.case = TRUE)
data_inner$aircraft = gsub("boeinger", 'boeing', data_inner$aircraft, ignore.case = TRUE)
data_inner = data_inner %>% group_by(airport_name, aircraft) %>% summarize(count = n()) %>% arrange(desc(count))
data_inner$country <- c("Canada", "South Korea", "Malaysia", 'UAE', 'USA', 'Bahrain', 'Brunei', 'China', 'UK', 'Burundi', 'Bangladesh', 'UAE', 'Ireland', 'China', 'Saudi Arabia', 'Ukraine', 'Ukraine', 'India', 'UK', 'USA', 'Jamaica', 'USA', 'France', 'Congo', 'Canada', 'Austria')
data_inner = data_inner %>% group_by(country, aircraft) %>% summarize(count = n()) %>% arrange(desc(count))
ggplot(data_inner, aes(x = country, y = count, fill = aircraft)) +
  geom_bar(stat = "identity") +
  labs(title = "Airplanes per country", x = "Country", y = "Airplanes total") +   theme(axis.text.x = element_text(angle = 45, hjust = 1)) + scale_fill_discrete(name = "Aircraft type")

```

**Ответ:** наиболее количество самолетов airbus находится в *Китае*, наибольшее количество самолетов boeing -- в *США* и *Великобритании*. Наибольшее число самолетов в целом -- в *США*.

**Вывод:** в итоге, мы получили ряд аэропортов с количеством самолетов по типам. К сожалению, для дальнейшего анализа может потребоваться преобразование данных и включение информации о стране авиакомпании/аэропорта. В противном случае, если бы мы получили очень большой датасет, то было бы практически невозможно учесть, что в одной стране может быть несколько аэропортов (да и в одном городе тоже, например!). Это невозможно никак проверить, кроме как ручным перебором, что, опять же, достаточно энерго- и времязатратно. Также было бы интересно посмотреть, какие авиакомпании владеют большинством боингов и аэробусов, но тут тоже надо учитывать, что далеко не всегда в названии у них будет указана страна происхождения, и здесь тоже требуется преобразование данных с добавлением недостающей информации. И, как уже было указано, я бы посоветовала узнать больше о связи между типом самолета и удовлетворением пассажиров посредством оценки отзывов и рейтинга.

### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами 

**Элемент 1:** 

 - вид: график
 
 - ответ на вопрос: 1
 
 - обоснование: используется столбчатая диаграмма, потому что оценка воспринимается как категориальная величина, поэтому наиболее корректным методом иллюстрации данных являются именно столбчатые диаграммы. Данные разбиты по дням недели, чтобы было более понятно, что именно воскресенье создает такую "просадку" в среднем рейтинге за выходные. 
 
**Элемент 2:** 

 - вид: число
 
 - ответ на вопрос: 2
 
 - обоснование: Сам график рейтинга лаундж зон не особо интерес в том смысле, что достаточно знать, что больше всего любой контент про чистоту/грязь в лайндж зонах встречался в отзывах с низким рейтингом (то есть с рейтингом = 3), что позволяет сделать вывод о том, что это очень частая тема в отзывах с низкой оценкой. Компании стоит быть более внимательной к опрятности своих помещений. 
 
**Элемент 3:** 

 - вид: график
 
 - ответ на вопрос: 3
 
 - обоснование: Поскольку страна не может быть непрерывной переменной, это только категориальная переменная, то наилучшим образом репрезентировать данные из таблицы можно только с помощью столбчатой диаграммы. Также на графике видно, как по типам самолетов отличается оснащение аэропортов в разных странах мира. 
 
**Элемент 4:** 

 - вид: число
 
 - ответ на вопрос: 1
 
 - обоснование: в первом элементе были выведены данные по дням, теперь же стоит вывести данные по категории дней для большей наглядности в ответе на вопрос. 
 
### Общие выводы

Проанализировав ряд датасетов, мы можем прийти к следующим выводам: 

1) Для привнесения качественных изменений в сервис как в аэропортах в целом, так и в лаундж-зонах в частности, владельцам требуется проанализировать отзывы на предмет жалоб. В случае с аэропортами -- разобраться, что меняется в зависимости от дня недели, в случае с лаундж зонами -- понять, насколько проблема чистоты или загрязненности пространства является ключевой для людей, недовольных сервисом. Для этого требуется проводить дополнительный анализ. 

2) Есть очевидная недостаточность данных для полного межстранового анализа, потому что ни в одной таблице страна не указывается по отношению к авиакомпаниям/аэропортам, а страна происхождения пассажира, на самом деле, едва ли имеет исследовательский интерес для владельцев. Поэтому желательно дополнить данные, чтобы появилась возможность проводить межстрановые сравнения. 
